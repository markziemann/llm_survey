Abstract

   Historically, the evolution of bats has been analyzed using a small
   number of genetic loci for many species or many genetic loci for a few
   species. Here we present a phylogeny of 18 bat species, each of which
   is represented in 1,107 orthologous gene alignments used to build the
   tree. We generated a transcriptome sequence of Hypsignathus monstrosus,
   the African hammer-headed bat, and additional transcriptome sequence
   for Rousettus aegyptiacus, the Egyptian fruit bat. We then combined
   these data with existing genomic and transcriptomic data from 16 other
   bat species. In the analysis of such datasets, there is no clear
   consensus on the most reliable computational methods for the curation
   of quality multiple sequence alignments since these public datasets
   represent multiple investigators and methods, including different
   source materials (chromosomal DNA or expressed RNA). Here we lay out a
   systematic analysis of parameters and produce an advanced pipeline for
   curating orthologous gene alignments from combined transcriptomic and
   genomic data, including a software package: the Mismatching Isoform
   eXon Remover (MIXR). Using this method, we created alignments of 11,677
   bat genes, 1,107 of which contain orthologs from all 18 species. Using
   the orthologous gene alignments created, we assessed bat phylogeny and
   also performed a holistic analysis of positive selection acting in bat
   genomes. We found that 181 genes have been subject to positive natural
   selection. This list is dominated by genes involved in immune responses
   and genes involved in the production of collagens.
     __________________________________________________________________

   The bat order Chiroptera is one of the most common and diversely
   adapted orders of organisms on Earth. Estimates of the exact number of
   species vary, but all estimates show bats represent a large portion of
   the known mammalian species, representing ∼925 of 6,400 known species,
   about 15% ([35]1, [36]2). Several characteristics of bats make them
   inherently interesting, most uniquely their ability to fly and
   echolocate. Bats are also notorious for harboring viruses that transmit
   to humans [called zoonotic viruses ([37]3)]. For instance, bats are the
   established reservoir hosts for SARS coronavirus, Nipah virus, and
   Hendra virus ([38]1, [39]4). Hypsignathus monstrosus, the hammer-headed
   bat, has been identified as a possible reservoir host of Ebola virus
   ([40]5, [41]6). Marburg virus, a close relative of Ebola virus, has
   been isolated from Rousettus aegyptiacus ([42]7, [43]8).

   Unfortunately, the diversity that makes bats interesting also makes
   them difficult to study. Genetic information allows researchers to gain
   a deeper understanding of the evolutionary origins of such diverse
   taxa. There are several previous phylogenic analyses conducted with
   bats across the order Chiroptera ([44]9–[45]16). Given the difficulty
   of obtaining genetic data from a species group with such extreme
   diversity, there has historically been a tradeoff between number of
   loci analyzed and number of species analyzed (i.e., more loci can be
   reasonably analyzed only when a smaller number of species is
   considered). Some studies tackle hundreds of species at once. Most
   recently, Amador et al. constructed a tree containing 799 species by
   performing a supermatrix analysis with maximum likelihood and maximum
   parsimony methods using up to nine gene sequences per species ([46]16).
   High-throughput sequencing is now lessening the burden of this tradeoff
   because a number of bats across the order Chiroptera have had their
   genomes or transcriptomes sequenced in bulk. Two studies have
   undertaken phylogenetic analyses of these large datasets ([47]13,
   [48]15).

   In most evolutionary studies, the unit of analysis is the orthologous
   multiple sequence alignment. Ideally, one creates a set of alignments
   representing each gene, each of which includes the correct ortholog
   from each species under analysis. However, accurately assembling short
   reads, identifying orthologs, and curating/vetting multiple sequence
   alignments from transcriptomic and genomic data are difficult tasks in
   an evolving field ([49]17). In previous studies of bats that employed
   high-throughput sequencing data, these bioinformatic issues were
   partially addressed by collecting most of the data at the same time
   with similar methods: whole-genome sequencing in the case of
   Tsagkogeorga et al. ([50]13) or transcriptomes in the case of Lei and
   Dong ([51]15). However, the complexities of creating high-quality
   orthologous sequence alignments are compounded when public data from
   multiple sources are combined because these datasets have been
   collected with a variety of methods and from either chromosomal DNA or
   transcribed RNA. These issues may, in part, explain why the phylogenies
   of bats that have been created to date agree on much of the history of
   Chiroptera but differ in many ways as well.

   The same data required to investigate phylogeny—namely, multiple
   sequence alignments of all available genes—is also highly valuable for
   guiding research into selective pressures that have influenced the
   genomes of bats. Of particular interest would be genes that have
   undergone positive natural selection in bats, possibly allowing them to
   better survive infection by viruses but also likely improving other
   processes that are specific to bat physiology, immunology, or ecology
   ([52]18–[53]20). Positive natural selection produces in gene alignments
   an unusually high ratio of DNA substitutions which change the protein
   sequence (dN) to those that do not (dS), measured by dN/dS > 1 ([54]21,
   [55]22). Limited previous analysis of positive selection in bat genomes
   has been performed. Typically, selection has been analyzed only in key
   gene families for specific purposes ([56]13, [57]23, [58]24). These
   studies yielded interesting results, but we still lack a holistic view
   of the categories of genes most affected by selection in bat genomes.

   We set out to perform a metaanalysis of available Chiropteran annotated
   genomes and transcriptomes, with three principal goals: a carefully
   curated set of orthologous gene alignments, a high-confidence
   phylogeny, and positive selection measurements for each gene. In the
   process of obtaining these goals, we developed a curation and cleaning
   pipeline for producing high-quality orthologous multiple sequence
   alignments from datasets combining public data from multiple sources.
   We also produced transcriptomic data for R. aegyptiacus that
   complements previously published data ([59]25, [60]26) and a
   transcriptomic dataset for H. monstrosus.

Results

Data Collection and Assembly.

   The bat species analyzed in this study and the type of data associated
   with each are shown in [61]Table 1. For a few bat species, genomic
   (chromosomal) sequences are available, and for others, transcriptomic
   sequences exist. For each bat species with an annotated genome project,
   we downloaded the relevant RefSeq database from the National Center for
   Biotechnology Information (NCBI) website and extracted the protein and
   coding sequence of the longest isoform of each gene for orthology
   search. After finding orthologous genes from each species, we selected
   the gene isoform which most closely matched the consensus sequence for
   further analysis ([62]Methods). Genome assembly accession numbers, as
   well as basic assembly statistics, for each genome are given in [63]SI
   Appendix, Table S1. Human, common shrew (Sorex araneus), and pig (Sus
   scrofa) genomes were also included as outgroups. Finally, we harvested
   mRNA and sequenced the transcriptomes of H. monstrosus and R.
   aegyptiacus on Illumina machines ([64]Methods). For all other bats with
   available transcriptome data, we downloaded the raw sequencing reads
   from the Sequence Read Archive ([65]SI Appendix, Table S2) ([66]23,
   [67]27–[68]38).

Table 1.

   Chiroptera data overview
   Species Genome/transcriptome Annotated genes N50 %GC Assembly count
   Artibeus jamaicensis Transcriptome 10,071 2,166 53.4 16
   Carollia brevicauda Transcriptome 3,954 1,284 51.3 12
   Cynopterus sphinx Transcriptome 6,232 1,653 49.8 12
   Desmodus rotundus Transcriptome 9,019 2,115 52.8 18
   Eptesicus fuscus Genome 13,248 2,235 54.2 n/a
   Hypsignathus monstrosus* Transcriptome 7,875 2,040 49.8 17
   Macrotus californicus Transcriptome 4,375 1,557 51.9 12
   Miniopterus schreibersii Transcriptome 11,089 2,202 53.4 19
   Murina leucogaster Transcriptome 9,267 2,055 53.6 14
   Myotis brandtii Genome 12,674 2,229 53.1 n/a
   Myotis davidii Genome 12,353 2,223 53.2 n/a
   Myotis lucifugus Genome 12,386 2,214 53.2 n/a
   Myotis ricketti Transcriptome 4,868 1,401 51.1 12
   Pteropus alecto Genome 13,295 2,235 52.4 n/a
   Pteropus vampyrus Genome 13,145 2,232 52.3 n/a
   Rhinolophus ferrumequinum Transcriptome 6,764 1,761 53.8 12
   Rousettus aegyptiacus* Transcriptome 9,714 2,235 52.8 18
   Tadarida brasiliensis Transcriptome 6,128 1,869 51.4 12
   Homo sapiens (outgroup) Genome 13,206 2,301 52.2 n/a
   Sorex araneus (outgroup) Genome 12,190 2,280 55.7 n/a
   Sus scrofa (outgroup) Genome 11,304 2,142 53.8 n/a
   [69]Open in a new tab

   Each species analyzed in this study, along with basic information
   concerning data type (genomic or transcriptomic), the number of genes
   here placed in orthologous gene sets, the N50 statistic (50% of bases
   are in contigs of length at least N50), and guanine–cytosine content
   (%GC) of these genes. For bats with transcriptomic data, data were all
   assembled and annotated as part of this study, and the number of
   assemblies constructed and analyzed is listed. For the other species,
   genomic data and annotations were all downloaded from RefSeq.
   Transcriptome data for two species, shown with asterisks, were
   generated in this study.

   For the sake of consistency, we constructed transcriptome assemblies
   using our own pipeline, even in the cases where authors made assemblies
   publicly available. Briefly, our pipeline consisted of removing adapter
   sequences with Trimmomatic ([70]39), followed by using two of the most
   popular transcriptome assemblers, the De Bruijn graph-based Trinity
   ([71]40) and Trans-ABySS ([72]41) assemblers, with a range of input
   parameters. This resulted in multiple tentative assemblies per bat
   ([73]Table 1 and [74]Methods) ([75]39–[76]42).

Building Orthologous Gene Families.

   The search for orthologous genes was performed in two primary steps.
   First, we searched for orthologs in the genomic datasets. With genomic
   data, one is able to use syntenic information to help predict
   orthology. We used all-v-all BLAST reciprocal best hits of the protein
   sequences, filtered using three sources of syntenic information: public
   orthology predictions from BioMart, proximity via whole genome
   alignment, and proximity of similar neighboring genes ([77]43–[78]45).
   Second, we searched for orthologs in transcriptomic datasets. We
   selected the best BLAST reciprocal best hits in transcriptomic data
   against genes found in the genomic orthologous gene sets, filtered by
   search using HMMER ([79]46), a hidden Markov model-based homology
   search software package, and filtered by match length ([80]Methods).

   In all, we were able to place 192,686 transcripts into 11,677
   orthologous gene sets, of which 1,107 contain genes from all species
   and outgroups. [81]Fig. 1 shows the number of transcriptomic genes
   found by species. Also shown is the number of genes we would have found
   in each species had we known a priori which assembly would perform the
   best for each bat and only assembled that one. With the additional work
   of analyzing multiple assemblies per bat, we were able to identify
   9–22% more genes per bat relative to the best single assembly,
   representing thousands of added transcripts and improvements to the
   completeness of the gene network.

Fig. 1.

   [82]Fig. 1.
   [83]Open in a new tab

   Use of multiple assembly methods improves recovered gene counts. For
   each species where transcriptome data are being used, the number of
   genes placed in an orthologous gene family based on all assemblies is
   reported (blue), as well as the number of genes which could have been
   found from the best single assembly alone, had it been known a priori
   (gold). Which assembly was best for each species is shown as the labels
   for gold bars, where TrinAll indicates the Trinity assembly using all
   reads, and TranskXX indicates the Trans-ABySS assembly using the De
   Bruijn graph of k-mers of length XX. Number of genes added through use
   of multiple assemblies over the best assembly, and percentage increase,
   are shown to the right of the bars. Use of multiple assemblies added
   9–22% more annotated orthologs per species relative to the best single
   assembly. Species with raw data generated for this paper are shown in
   blue type.

Multiple Sequence Alignment Cleaning.

   Manual inspection of many multiple sequence alignments of orthologous
   genes revealed a nonrandom source of error: the species were biased
   toward segregating by data type (i.e., genomic data vs. transcriptomic
   data). Some poorly aligned regions would tend to agree within data type
   but disagree between data types. An example is shown in [84]Fig. 2A.
   Furthermore, the splits were observed to happen at sharp boundaries
   highly suggestive of exon boundaries. This effect can be largely
   explained by the fact that we chose the longest isoforms predicted from
   annotated genome sequences, even though the longest isoforms might not
   be expressed at high enough levels to appear in the transcriptomic
   datasets from a given tissue. Other artifacts in transcriptomic or
   genomic data assembly and annotation could also contribute to this
   effect. Quantification of this bias, based on the cleaning pipeline
   described below, is shown in [85]SI Appendix, Fig. S2.

Fig. 2.

   [86]Fig. 2.
   [87]Open in a new tab

   Multiple sequence alignment cleaning. (A) Some multiple sequence
   alignments were observed to demonstrate isoform selection biased toward
   separation of genomic and transcriptomic data, causing nonrandom,
   nongapped errors segregated by the artifact of data type. (B) The
   alignment cleaning pipeline. First, each gene derived from genomic data
   was revisited to choose the isoform which best matches the consensus
   alignment sequence. Second, exons were filtered by structure, where
   exons with disagreement about boundary positions in the alignment and
   exons with >1% length difference between species were filtered out.
   Last, exons were filtered using the MIXR algorithm described in the
   text. (C) A total of 3,444 improved genomic isoform selections were
   performed, shown as a function of the improvement in percent matching
   the consensus sequence, i.e., (percent matching after) – (percent
   matching before). (D) Counts of unanimous second-consensus runs after
   each step of the alignment cleaning pipeline (with steps progressing
   from top to bottom in the graph). Unanimous second-consensus runs are
   defined as runs of more than three columns in a row where some minority
   of bat sequences agree with each other but disagree with those of all
   other bats. The final output contains only seven such runs with two or
   more species, and these are only up to three species and five amino
   acids long. (E) In each step of the alignment cleaning pipeline, weakly
   conserved sites are filtered at higher rates, enriching the final
   alignments for conserved sequences. “Strong,” “Weak,” and “None”
   conservation categories are as defined by Clustal ([88]47). Percent
   reduction in multiple sequence alignment column counts shown to the
   right. (F) Column conservation of the first 2,000 columns of the
   longest 2,000 alignments before and after exon filtering.

   To ameliorate nonrandom assembly and isoform-selection artifacts, we
   developed a three-step cleaning algorithm for the multiple sequence
   alignments ([89]Fig. 2B). First, we revisited each gene derived from
   genomic data and replaced it, if necessary, with the isoform closest to
   the consensus sequence. This resulted in improvements to 3,444
   transcripts, with transcripts improving their match to the consensus
   sequence by an average of 8%, although there was a wide range of
   percent improvements ([90]Fig. 2C).

   Second, we removed exons if the species did not all agree on the exon
   structure. Specifically, we removed exons if all species did not agree
   on the aligned exon boundaries or if exon sequences differed too much
   in length. For phylogenetic analysis, where all genes are used in
   aggregate to fit a single tree, we required exact agreement in exon
   lengths. For gene-level positive selection analysis we required exons
   differ by no more than 1%. This cutoff was chosen because we observed
   it to be a transition point to high-gap exons in our data ([91]SI
   Appendix, Fig. S1). [92]Fig. 2 D–F are based on the latter threshold,
   and [93]SI Appendix, Fig. S4, shows the equivalent figures for the
   former.

   Third, we developed the Mismatching Isoform eXon Remover (MIXR)
   software package to detect and remove exons with alternate consensus
   runs directly (available at [94]http://github.com/hawkjo/mixr). By
   alternate consensus run, we mean the situation as shown in [95]Fig. 2A,
   where some subset of species has a long run of amino acids which are
   internally consistent but which disagree from the majority of the
   sequences. While no substitution pattern in a single column of an
   alignment can distinguish real biological mutations from artifactual
   mismatching of isoforms, runs of an alternate consensus sequence are
   exponentially unlikely as a function of run length according to all
   site substitution models, so we want to remove them before analysis.
   Briefly, the MIXR algorithm works as follows. First, we define the
   alternate-consensus-run score, designed to give high scores to runs
   where some subset of species is internally consistent but differs from
   the majority of species. We then find the maximum
   alternate-consensus-run score for all species bipartitions (divisions
   of the species into two subsets) in a given alignment, such as the
   bipartition into transcriptomic and genomic species in [96]Fig. 2A.
   Finally, exons with significant scores are removed. See [97]Methods for
   additional details.

   Note that in all three of our cleaning steps, we have tried to avoid
   filtering on sequence divergence as much as possible. This is because
   our intention is to perform positive selection analysis on the cleaned
   alignments, an analysis which measures the ratio between nonsynonymous
   and synonymous mutations. Filtering strategies based on whether the
   protein sequences agree will directly bias the data in favor of
   synonymous mutations, and the exon-length-matching and MIXR steps are
   expected to have this effect to some degree. However, to whatever
   degree this is true in our data, it will have a conservative effect,
   biasing the data to fewer rather than more significant hits in a
   positive selection analysis.

   To measure the efficacy of each of our filtering steps, we looked at
   two different measures of the filtering process. First, we looked at
   unanimous second-consensus runs. We define unanimous second-consensus
   runs to be runs in an alignment where some subset of species has
   unanimous agreement of the amino acid sequence but disagrees with the
   majority of species. This is correlated with but distinct from the
   alternate-consensus runs defined for the MIXR algorithm as it is
   independent of the substitution model used for the MIXR scoring
   function. The results after each step of the cleaning process are shown
   in [98]Fig. 2D. We see that the most significant reduction in
   second-consensus runs is due to the exon structure filtering step, and
   MIXR cleaned up essentially all of the runs which passed the previous
   two steps. After cleaning, only seven runs of more than three columns
   were detected, and those were up to only five columns in length.
   Furthermore, all but one of these alignments contained only species
   with genome data available, removing the concern of separation by data
   type.

   As a second measure of alignment improvement, we checked that the
   filtered sequences had increased overall sequence conservation. Our
   strategy, as expected, preferentially discriminates against more weakly
   conserved sites [as defined by CLUSTAL ([99]47)], filtering >80% of
   nonconserved sites vs. 44% for unanimous sites, and almost all gapped
   sites ([100]Fig. 2E). Furthermore, both the exon-structure filtering
   step and the MIXR algorithm improve sequence conservation. [101]Fig. 2F
   shows the positions and distribution of conserved sites in the first
   2,000 multiple sequence alignments. Many of the poor quality exons are
   at the ends of the alignments, which is to be expected. The ortholog
   finding process scores sequences based on length of agreement, which
   naturally tends to include matching sections in the center. The ends
   are then more free to vary, with variability expected due to
   differences in isoform selection, as well as due to incomplete or
   incorrect transcript assembly. Transcripts tend to have less coverage
   near the ends and correspondingly poorer assembly. This also helps
   explain why so many unanimous sites end up being filtered: correctly
   matched exons will still be filtered if partial assembly results in
   exons of different lengths. From these results, as well as manual
   inspection, the alignments have significantly fewer erroneous columns
   after exon filtering.

Phylogenetic Analysis.

   Phylogenetic trees were constructed from these multiple sequence
   alignments, using multiple strategies and software packages. First,
   using the 1,107 genes found in all species, we constructed the species
   tree with a partitioned nucleotide analysis in Mr. Bayes ([102]48),
   which fits for one species tree while allowing the model parameters to
   vary for each gene. Next, using the same genes, we constructed the
   species tree with concatenated data using RAxML ([103]49). This we did
   for the full coding sequence (CDS), the amino acid sequence, and each
   codon position separately. We additionally fit the phylogenetic tree
   using RAxML with the CDS sequence of the longest 100 alignments after
   subjecting the corresponding amino acid alignments to manual
   inspection. The full length of all 100 alignments looked highly
   credible to manual inspection. Finally, we constructed the 1,107 gene
   trees with all species using Mr. Bayes and determined the species tree
   via coalescent analysis as implemented in ASTRAL ([104]50). This was
   done for the full CDS sequence and each codon position separately.

   The final tree is shown in [105]Fig. 3A, with reported posterior
   probabilities given from the Mr. Bayes partitioned analysis. We refer
   to the final tree instead of a specific version of the final tree due
   to the strong consensus between methods. A summary of how the methods
   agreed or disagreed is shown in [106]Fig. 3B. All methods converged on
   nearly the same species tree. In fact, due to the large amount of data,
   all nodes resolved with 100% reported posterior probability in both Mr.
   Bayes analyses. The only species not consistently placed in every
   analysis were Cynopterus sphinx and Murina leucogaster. Their
   alternative placements are shown in [107]SI Appendix, Fig. S5.

Fig. 3.

   [108]Fig. 3.
   [109]Open in a new tab

   Chiroptera phylogeny. (A) The consensus phylogeny for the bats
   considered in this study, plotted with FigTree ([110]102). Branch
   lengths and posterior probability for nodes are from the Mr. Bayes
   partitioned analysis with full codon model, which agrees at all nodes
   with the consensus tree. Historical designations of microbat and
   megabat are listed, as well as the newer divisions of
   Yinpterochiroptera and Yangochiroptera. (B) Comparison of trees
   constructed by various methods with the consensus tree. For each tree
   method, the rectangle at each node indicates agreement or disagreement
   with the consensus tree on the implied split at the node. Comparison
   with previously published trees is shown below. For nodes B, E, L, and
   P, the previously published trees agree with either our consensus
   phylogeny or a single alternative hypothesis: R. ferrumequinum above
   node G, C. sphinx above node C, M. schreibersii above node H, or M.
   leucogaster above node N, respectively. AA, amino acid sequence; C1–C3,
   the coding sequence restricted to those bases in the first, second, or
   third codon position, respectively; 100 manually inspected, phylogeny
   constructed using the longest 100 alignments after manual inspection
   for artifacts (none observed).

   Also included in [111]Fig. 3B are comparisons with previously published
   trees, in particular, those that included most of the species in our
   analysis. All species placements in our final tree agree with these
   trees, with the exception of two previously controversial species,
   Rhinolophus ferrumequinum and Miniopterus schreibersii; one
   particularly close node involving C. sphinx; and one surprising
   placement, M. leucogaster. Other order-wide phylogenetic analyses were
   omitted from [112]Fig. 3B due to minimal overlap with the species
   considered here.

   The placement of R. ferrumequinum addresses the first branching of the
   order Chiroptera. The traditional division of order Chiroptera into
   Megachiroptera and Microchiroptera, the large and small bats,
   respectively, has been challenged in recent years as molecular
   phylogenetic analyses have gained prominence. An alternative history
   has been proposed, dividing bats into two suborders named
   Yinpterochiroptera and Yangochiroptera ([113]51). In the proposal, the
   microbat families Rhinopomatidae, Rhinolophidae, Hipposideridae, and
   Megadermatidae are joined with the megabats to form the new clade
   Yinpterochiroptera, while the rest of the microbats form
   Yangochiroptera. Our phylogeny agrees with this model, with R.
   ferrumequinum falling into Yinpterochiroptera ([114]Fig. 3A). This
   restructuring has gained additional recent support ([115]9, [116]11,
   [117]13, [118]15, [119]52), although it must be noted that the accurate
   rooting of ancient species groups is a notoriously difficult aspect of
   phylogenetics ([120]44).

   The placement of M. schreibersii has also been unclear. Agnarsson’s
   cytochrome B-based phylogeny places M. schreibersii just outside node H
   on our phylogeny. On the other hand, our placement of M. schreibersii
   agrees with Hoofer et al. ([121]53), who argued that due to this
   placement and the large divergence, Miniopteridae deserves to be its
   own family, and this agrees with the other phylogenies shown in
   [122]Fig. 3B as well.

   The most surprising placement in our tree is that of M. leucogaster. In
   all of our calculated trees shown in [123]Fig. 3B, with 100% reported
   posterior probability where calculated, M. leucogaster disrupts the
   monophyly of the genus Myotis ([124]Fig. 3B and [125]SI Appendix, Fig.
   S5). One must keep in mind, however, that the quantity of data here
   considered is so large it will tend to produce results with 100%
   reported posterior probability at each node, pushing the question of
   credibility further upstream to the quality of the data. No data
   assembly and cleaning strategy, including our own, is perfect, and it
   is possible that sufficient errors remain in our data as to result in
   an erroneous topology of such closely related species. It at first even
   seems suggestive, given our previous observations of bias by data type,
   that M. leucogaster has moved closer than expected to Myotis ricketti,
   the Myotis species represented by transcriptomic data. [126]SI
   Appendix, Fig. S6, takes a focused look at the data for these five bats
   in the 100 manually inspected alignments. Strikingly, the bipartition
   of M. leucogaster as outgroup to Myotis has less than or equal the
   support of any other Myotis bat being outgroup to Myotis + M.
   leucogaster. This includes the hypothesis of M. ricketti as outgroup,
   which should have near-zero support under the data-type bias
   hypothesis. Meanwhile, the bipartition of M. leucogaster, M. ricketti,
   and Myotis davidii vs. the other two Myotis bats is the bipartition
   most clearly supported by the data. Furthermore, the relationships
   between the ranges of the bats in this clade roughly match our
   consensus phylogeny: M. ricketti lives in southeast Asia, M. davidii
   lives in central China, M. leucogaster lives in southeast Asia and
   central China, Myotis brandtii lives across Europe and parts of
   northern Asia, and Myotis lucifugus lives in North America
   ([127]54–[128]58). We recognize that this placement is surprising given
   previously published work, but our results suggest the placement of M.
   leucogaster may merit further consideration.

   One final species placement of note is Desmodus rotundus. The family
   Phyllostomidae (New World leaf-nosed bats) here consists of the bats
   within the clade defined by node H. Wetterer, et al. ([129]59) proposed
   that the genus Desmodus be placed sister to the rest of the
   phyllostomids, which were to have formed the subfamily Phyllostominae.
   Our placement of Macrotus californicus, however, disrupts
   Phyllostominae, in agreement with the tree proposed by Rojas et al.
   ([130]60).

Positive Selection Analysis.

   Finally, we looked within bat genomes for signatures of positive
   selection acting on protein-coding genes. We used the PAML software
   package ([131]61) to identify dN/dS > 1 codons within each of the
   orthologous gene alignments that we created. We used codon models M8
   and M8a, which estimate the evolutionary pressures that have acted at
   specific codon sites over the entire phylogeny of species included.
   These models do not consider unique evolutionary scenarios that have
   affected gene evolution along different branches over the phylogenetic
   tree like some other models. In M8, the data in each multiple sequence
   alignment is fit to a model where one group of codons from within the
   alignment is allowed to evolve with dN/dS > 1. M8a is the null version
   of this model, where that same category of codons is allowed but is
   constrained to dN/dS = 1. Because there is one additional degree of
   freedom in M8, the data will usually fit better to the M8 model (as
   estimated by a likelihood value). A gene was deemed to be evolving
   under positive selection when the data are a statistically better fit
   to M8 than to M8a (P < 0.05 after correction for multiple tests;
   [132]Dataset S1). We performed this analysis on 10,650 genes that met
   criteria of having at least six species and 30 codons represented in
   the alignment. Out of these, 181 genes met the statistical criteria for
   being subject to positive natural selection, and these genes were
   hand-curated for function ([133]Dataset S1). [134]Table 2 shows a
   subset of the genes. Nineteen percent are known to be involved in
   immunity or the replication cycles of pathogens. Surprisingly, 8% are
   known to be involved in collagen formation, including 10 out of the 27
   top scoring genes for positive selection ([135]Dataset S1). We also
   looked at the gene ontology (GO) classifications which are
   overrepresented in the list of genes under positive selection and
   present this data in [136]Dataset S2. The GO categories most enriched
   for positively selected genes are dominated by immune responses and
   collagen formation.

Table 2.

   Some of the 181 genes under positive selection in bats
                                                           Genes
 Immunity/pathogens (n = 35, 19% of total) ANPEP/CD13
                                           C4BPB/C4BP
                                           C5/complement C5
                                           CALCOCO2/NDP52
                                           CCL21
                                           CCL25/TECK
                                           CD36[137]^*
                                           CD53
                                           CD63
                                           CD83
                                           CFP/properdin
                                           CRISP3[138]^*
                                           CTSW/cathepsin W
                                           CYBB/cytochrome b-245 beta chain
                                           DPP4/CD26
                                           ENPP3/E-NPP3/CD203c
                                           GYPA/CD235a/glycophorin A
                                           HLA-DMB
                                           ICAM3/CD50
                                           IL7/interleukin 7
                                           IQGAP2
                                           LTF/lactotransferrin[139]^*
                                           LY49
                                           LY6G5C
                                           MMP12
                                           MX1/MxA
                                           ORC2
                                           PON3/paraoxonase 3
                                           PRF1/perforin 1
                                           SAMHD1
                                           SEMA7A/semaphorin 7A
                                           SIGLEC1/CD169
                                           SRGN/serglycin
                                           TF/transferrin
                                           ZC3HAV1/ZAP
 Sexual reproduction (n = 15, 8% of total) CATSPER3
                                           CCDC136
                                           CCDC146
                                           CRISP3[140]^*
                                           FAM217A[141]^†
                                           FETUB/fetuin B
                                           HbE1/HbE/embryonic hemoglobin subunit
                                           IQUB[142]^†
                                           LTF/lactotransferrin[143]^*
                                           MSMB/IgBF
                                           PRR9[144]^†
                                           PZP
                                           RBM44[145]^†
                                           SLC26A8
                                           TMEM62
 Collagen formation (n = 9, 5% of total)   ANO5
                                           CD36[146]^*
                                           COL11A2
                                           COL16A1
                                           COL18A1
                                           COL1A2
                                           COL28A1
                                           COL3A1
                                           COL4A1
                                           COL4A2
                                           COL4A3
                                           COL4A5
                                           COL4A6
                                           COL5A3
                                           COL7A1
                                           COL9A2
                                           MMP12
                                           TMEM38B/TRIC-B
                                           TSC1
 Peroxisome (n = 9, 5% of total)           ACAA1
                                           ACOX2
                                           ACSL5
                                           AGPS
                                           DHRS4
                                           EPHX2
                                           PECR
                                           PHYH
                                           PXMP4
   [147]Open in a new tab
   ^*

   These genes are placed in two categories on this table.
   ^^†

   Relatively little is known about these genes, but they are expressed
   solely in the testis.

Discussion

   Understanding the evolutionary history of bats is important not just
   for the study of Chiropteran zoology but also for the study of bats as
   reservoirs of deadly human viruses. Knowledge of an accurate phylogeny
   improves analysis of positive selection in bat genomes because dN/dS
   analysis requires both gene alignments and a phylogenetic relationship
   of the orthologs being analyzed. Also, the reliable identification of
   gene orthologs will allow molecular biologists to functionally test
   differences in these genes from one species to the next ([148]62).
   Functional studies such as these will allow us to understand whether
   some bats have unique features of their immunity that allow them to
   harbor viruses that are dangerous to humans ([149]63). Herein, we have
   curated multiple sequence alignments of thousands of bat genes. Using
   both genomic and transcriptomic data, we were able to find 11,677
   orthologous gene families. To enhance these alignments, we provided
   transcriptome data for two of these bats, H. monstrosus and R.
   aegyptiacus, from which we annotated 7,858 and 9,682 genes,
   respectively. We furthermore developed a general data cleaning method
   for filtering exons with nonrandom structural errors, in this case
   observed to result from genomic vs. transcriptomic data. For this
   method, we developed the MIXR software package which directly detects
   and removes alternate consensus run artifacts, and is available at
   [150]http://github.com/hawkjo/mixr. The multiple sequence alignments
   that we have created for bat genes, both before and after exon
   filtering, are available for use by the wider bat and virology
   communities ([151]http://numerical.recipes/chiroptera/). Using these
   alignments, we examined the history both of speciation and of positive
   selection in 18 species of bats. This study hopefully sets the stage
   for continued and more in-depth study of the evolution and functional
   differentiation of bat genes relevant to immunity and beyond.

   Using these orthologous gene families, we were able to reconstruct the
   phylogeny of the order Chiroptera using multiple methods. Due to the
   sheer scale of the data, we resolved each node in the tree with 100%
   reported posterior probability, although the topology differed slightly
   depending on the analysis method. Our results support the division of
   Chiroptera into the two suborders Yinpterochiroptera and
   Yangochiroptera, in disagreement with the traditional division into
   Megachiroptera and Microchiroptera. However, we acknowledge that
   rooting ancient clades continues to be a difficult phylogenetic
   problem, and further data may shed more light on this issue. We
   furthermore provide evidence for the placement of M. schreibersii, in
   which we agree with Hoofer and Bussche, supporting their proposal for
   the separation of Miniopteridae into its own family ([152]53). We also
   provide evidence for the disruption of proposed subfamily
   Phyllostominae by D. rotundus. Most intriguingly, we saw M. leucogaster
   placed in the Myotis genus, which will require further investigation.

   Finally, we have analyzed positive selection of genes during the
   speciation of bats, on a genome-wide basis. Previously, work aimed at
   describing adaptive evolution in bats primarily focused on their unique
   traits, selecting families of genes to study for selection. These
   studies can broadly be divided into two categories, those that dealt
   with specific life traits, such as echolocation or metabolism related
   to frugivory ([153]24, [154]64–[155]73), and those that were related to
   pathogens or immunity ([156]74–[157]80). There are three studies that
   used larger datasets, two of which used whole-genome data ([158]13,
   [159]23, [160]24). Unlike our study, Tsagkogeorga et al. ([161]13) used
   genome-wide data to ask which genes might explain the alternative
   subordinal topologies supported by their data. Similarly, the Shen et
   al. ([162]24) study was specifically interested in energy metabolism in
   bats due to their energy-expensive mode of locomotion, flight. Finally,
   Zhang et al. ([163]23) used whole-genome data available from two
   distantly related bats, along with orthologs from a number of mammals,
   and inferred adaptive evolution in the innate immune pathway and DNA
   damage checkpoint pathway. Our work, in comparison, includes more
   Chiropteran species and a holistic analysis of selection in the bat
   genome. The addition of more species, and the generation of a
   high-confidence tree for these species, gives us better resolution for
   detecting adaptive evolution specifically within Chiroptera ([164]81).

   We find that the positively selected genes in bats are dominated by
   genes involved with immunity. This could have something to do with the
   high pathogen load that bats are thought to carry ([165]3), but on the
   other hand, this finding is not unusual. Bats now join many other
   species groups in the finding that immune processes stand out for the
   strength of positive natural selection that has shaped them. The same
   has been found in many diverse species groups including primates
   ([166]82, [167]83), fish ([168]84), and insects ([169]85). It has been
   noted that the bats have some usual aspects of their immune systems
   ([170]86–[171]88), which could be consistent with the evolutionary
   signatures of rapid sequence evolution that we observe in many genes
   involved in immunity.

   Less clear to us is why so many genes involved in collagen formation
   seem to be under positive selection. Collagens are a family of
   structural proteins that form connective tissues in the body, including
   tendons, ligaments, and skin ([172]89). The walls of veins, arteries,
   and capillaries also contain collagen ([173]90). Collectively, the
   different forms of collagen constitute the most abundant protein in
   mammalian bodies ([174]89). Bat wings consist of a network of collagen
   ([175]91), and bats often have injuries on their wings which need to
   heal quickly ([176]92). Recently, Pseudogymnoascus destructans, a
   fungal pathogen that has killed more than 6 million bats, has been
   reported to damage collagen ([177]93). It is less clear how pathogens
   would have placed pressure on collagen-formation pathways in the past,
   across many species. Alternatively, it seems possible that the
   demanding physical and physiological constraints inherent in
   muscle-powered flight put bats at an edge of what is evolutionarily
   achievable. In that case, one might expect to see, after speciation
   events, comparatively more positive selection in wing- and
   flight-related genes compared with genes involved in other adaptations,
   with collagen an indicator of the former set.

   In summary, we have provided a way to combine genomic and
   transcriptomic data to build reliable multiple sequence alignments. We
   have created multiple sequence alignments for bat genes and made them
   publicly available. We have used these to produce a phylogeny and to
   assess positive selection in bat genes. Despite this progress, bats
   will continue to present challenges that push the limits of genomics
   and phylogenetics because of their high levels of sequence divergence.

Methods

Transcriptome Sequencing of H. monstrosus and R. aegyptiacus.

   RNA was isolated from the immortalized cell lines HypLu/45.1 and
   HypNi/1.1 (H. monstrosus) and RoNi/7.1 (R. aegyptiacus) ([178]94) using
   the AllPrep DNA/RNA mini kit (Qiagen- 80204). mRNA isolation, clean up,
   and library prep was done by the Genome Sequencing and Analysis
   Facility at University of Texas at Austin. Total RNA was enriched for
   mRNA using the Poly(A) Purist Magnetic kit (Life Technologies; AM1922).
   The mRNA was fragmented using the NEBNext Mg Fragmentation module (NEB;
   E6150S) and column purified using RNeasy MinElute kit (Qiagen; 74204).
   mRNA ends were repaired using T4 Polynucleotide kinase (NEB; M0201L)
   and ATP (Ambion; AM8110G). A final concentration step was run using the
   RiboMinus Concentration Module (ThermoFisher; K155005). Adaptors were
   ligated (NEB; E6120L), and mRNA was converted to cDNA (Invitrogen;
   18080093). The library was then PCR amplified and size selected. H.
   monstrosus cDNA was sequenced on Illumina HiSeqs 2000 and 2500, both
   generating 2 × 101 bp paired end reads, and R. aegyptiacus cDNA was
   sequenced on Illumina HiSeq 2000 and NextSeq, with 2 × 101 bp and 2 ×
   151 bp reads, respectively. Reads are available on the Sequence Read
   Archive under project numbers SRP158567 and SRP158571. Assembled
   transcripts are available on GenBank at accession numbers
   [179]GHDN00000000 and [180]GHDO00000000.

Data Cleaning and Assembly.

   Sequencing data were first cleaned to remove sequencing adaptors and
   low-quality bases with Trimmomatic ([181]39), with appropriate settings
   for each dataset. Trinity ([182]40) was run with all reads, with all
   reads with in silico normalization, and with ∼35 million read
   subsamples for those bats with large datasets as recommended in Francis
   et al. ([183]95). Trans-ABySS ([184]41) was run with k-mer lengths of
   32, 64, and all multiples of 5 from 25 to 60.

   For genomic data, loci annotated as alternative loci were ignored, as
   well as readthrough genes. A few instances appeared with isoforms
   labeled as separate genes; these were manually reduced to one longest
   isoform.

Ortholog Search.

   First, we found orthologs between all species using only the genomic
   datasets, where syntenic evidence helps confirm orthology rather than
   paralogy (see below). The first step was all-vs.-all BLAST-ing,
   filtered for e values no higher than 10^−5. Reciprocal BLAST hits (for
   limitations, see ref. [185]96) were considered as tentative ortholog
   predictions ([186]43). Tentative predictions were further filtered by
   including evidence from public ortholog annotation in Biomart and,
   where available, syntenic evidence (see below). The resulting ortholog
   prediction graphs for each gene were filtered to remove any connected
   components with paths connecting two genes from the same species.

   Next, we added orthologs from the transcriptomes. First, genomic
   transcripts were translated to amino acid sequence, and blastx-tblastn
   reciprocal BLAST hits were found between all genomic high-quality
   orthologous genes and all transcriptome assemblies, again using an
   e-value cutoff of 10^−5. We then created HMMER models of each of the
   genomic orthologous gene sets and searched within the reciprocal BLAST
   hit contigs for the best HMMER hit for each gene, filtering for those
   hits with e value below 10^−10, extracting only the portion of each
   contig specified in the HMMER hit. We then filtered all transcripts
   which differed in length from the median genomic sequence length by
   more than 25%.

Syntenic Evidence.

   Whole-genome alignments were performed following a procedure described
   on the University of California, Santa Cruz, Genome Browser wiki, which
   for our purposes only required aligning, chaining, and netting.
   Alignment was performed using Lastz ([187]97), while chaining and
   netting were performed with kentUtils ([188]45). Tentative orthologs
   are considered to have evidence of synteny if they are in syntenic
   regions, as defined by the top-level nodes of the net.

   The algorithm used for determining gene-proximity evidence of synteny
   is a simple extension of the algorithm in Jarvis et al. ([189]44). Let
   species A and species B have genes a[1] and b[1], respectively, which
   are tentatively orthologs. Then let a[2] be the nearest gene to a[1] on
   the same chromosome which has a tentative ortholog in species B, b[2].
   If the number of genes between a[1] and a[2] and the number of genes
   between b[1] and b[2] are both less than 5, then we consider the
   ortholog pair a[1]–b[1] to have syntenic evidence. If there are at
   least five genes in each direction, but the above is not true, then
   there is evidence against synteny. In the case of not enough genes to
   either side, it is undetermined.

Multiple Sequence Alignments and Best Genomic Isoforms.

   Multiple sequence alignments were generated on amino acid sequences
   with MAFFT L-INS-i, the slower but more accurate version of the popular
   MAFFT alignment software ([190]98). Manual inspection revealed that
   while the HMMER models had quite consistently found the same isoform
   from all of the transcriptomic datasets, the genomic data were slightly
   less consistent. This is not surprising, as different species can have
   different annotated longest isoforms. So, for each gene in each species
   with genomic data, we went back and found the isoform most similar to
   the consensus isoform.

   The algorithm for finding best splice variant for a gene g in a given
   orthologous set S is as follows. First, find the consensus sequence of
   S from the MAFFT L-INS-i alignment. The consensus sequence is the
   identity in each column of the amino acid which is found in a majority
   of transcripts, or X if no single value is the majority. Next, align
   all splice variants of gene g against the consensus sequence, again
   using MAFFT L-INS-i, and score each by the number of nongap, non-X
   positions in agreement with the consensus. Select the splice variant
   with the highest score. This resulted in improved selection of 3,444
   splice variants.

   Finally, we realigned for final gene alignments. Corresponding CDS
   alignments were created using pal2nal ([191]99).

MIXR.

   We developed the MIXR software to detect and remove alternate consensus
   runs (available at [192]http://github.com/hawkjo/mixr). The MIXR
   algorithm finds the maximum alternate-consensus-run score for each
   hypothesis bipartition of species and removes exons which overlap runs
   with significant scores—or species if removing exons would eliminate
   the entire alignment (see flowchart in [193]SI Appendix, Fig. S3). To
   implement this algorithm outline, we needed to define three things:
   hypothesis bipartitions of species, the alternate-consensus-run scoring
   function, and the method used to determine significance.

   First, we define hypothesis bipartitions of species. Scoring all
   bipartitions is computationally intractable because for n species,
   there are 2^n bipartitions. We use as a heuristic the set of all
   bipartitions in the alignment, by which we mean subsets of species A
   and B for which there exists a column i in the protein alignment where
   the sets of amino acids in A[i] and B[i] are disjoint, i.e., no amino
   acid in A[i] is in B[i] and vice versa. Note that this step does not
   require internal agreement within A[i] or B[i], just disjointness
   between them. On average, this required looking at fewer than 23
   bipartitions per alignment.

   Second, we define the scoring function. Let A and B be a bipartition of
   species such that A is the larger (or equal) subset, and let A[i] and
   B[i] be the corresponding sets of amino acids in the ith column. We
   wish to reward internal agreement within B and penalize agreement
   between A and B. Let M be a log-likelihood amino acid transition
   scoring matrix. We here use PAM30 from the NCBI toolkit, the scoring
   matrix used by BLAST recommended for detecting shorter sequences
   ([194]100). Then we define the score of the i^th alignment column,
   S[i], to be
   [MATH:
   <mrow><msub><mi>S</mi><mi>i</mi></msub><mo>=</mo><msub><mi>S</mi><mrow>
   <mi>i</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>+</mo><munder><mrow><mi
   >min</mi></mrow><mrow><msub><mi>b</mi><mn>1</mn></msub><mo>,</mo><msub>
   <mi>b</mi><mn>2</mn></msub><mo>∈</mo><msub><mi>B</mi><mi>i</mi></msub><
   /mrow></munder><mi>M</mi><mrow><mo>(</mo><mrow><msub><mi>b</mi><mn>1</m
   n></msub><mo>,</mo><msub><mi>b</mi><mn>2</mn></msub></mrow><mo>)</mo></
   mrow><mo>−</mo><mn>2</mn><munder><mrow><mi>max</mi></mrow><mrow><mi>a</
   mi><mo>∈</mo><msub><mi>A</mi><mi>i</mi></msub><mo>,</mo><mi>b</mi><mo>∈
   </mo><msub><mi>B</mi><mi>i</mi></msub></mrow></munder><mi>M</mi><mrow><
   mo>(</mo><mrow><mi>a</mi><mo>,</mo><mi>b</mi></mrow><mo>)</mo></mrow></
   mrow> :MATH]

   if S[i] so calculated is positive and zero otherwise, where S[0] = 0.
   That is, the minimum agreement in B must be high and the maximum
   agreement between A and B low for several columns in a row to gain a
   high score. The factor of 2 in the second term reflects penalizing both
   agreement from A to B and B to A and is necessary to penalize complete
   agreement between A and B.

   Finally, to determine significance, we build and score negative control
   sequences. The negative control sequences are constructed by shuffling
   all columns from all alignments which contain all species to construct
   sequences at least 100× as long as the longest alignment. For each
   alignment, we select the negative control sequences corresponding to
   the species in the alignment, truncate them to 100× the length of the
   alignment in question, and find the maximum score for each hypothesis
   bipartition. Alternate-consensus-run scores larger than their
   corresponding negative control score thus have P values ≲ 0.01, and are
   considered significant, to be removed as shown in flowchart [195]SI
   Appendix, Fig. S3. No multiple hypothesis correction is performed,
   conservatively removing borderline cases.

Phylogenetic Analyses.

   Partitioned analyses in Mr. Bayes ([196]48) used two runs with four
   chains, the 4 × 4 model run for 1,000,000 steps and the full codon
   model for 30,000 steps. Gamma models were also subsampled, resulting in
   a >99% reported posterior probability for the gtrsubmodel[123456] model
   under the 4 × 4 model and six models with >5% posterior probability for
   the full codon model: gtrsubmodels 123425 (24%), 123454 (17%), 123456
   (17%), 123424 (16%), 123121 (10%), and 123124 (10%). RAxML ([197]49)
   was run with the rapid bootstrapping and ML algorithm, the GTRGAMMA and
   PROTGAMMAGTR models, and with 100 different starting trees. Gene trees
   were created using Mr. Bayes using 100,000 steps sampled every 10 steps
   with 20,000 step burn-in and an inverse gamma model.

Positive Selection Analysis.

   Positive selection analysis was performed on the 10,650 orthologous
   genes alignments that had at least six species and 30 amino acids
   represented in the alignment. For each analysis, we used the species
   tree generated in this study. Using PAML ([198]61), each alignment was
   fit to the M8 and M8a codon models, both performed with the f61 codon
   model. Both the M8 and M8a models assume the dN/dS value for a given
   aligned codon is either a draw from a binned beta distribution (with
   fit parameters a and b) or a draw from a floating bin with parameter
   dN/dS = ω. The parameter ω can float to values >1 in M8 and is set to ω
   = 1 for M8a. P values were calculated via χ^2 test on twice the
   difference in reported log likelihoods of the two models, a
   likelihood-ratio test of nested models. GO category enrichment among
   positively selected genes was performed with the STRING database online
   software ([199]101).

Software Versions.

   Software versions used in this project were Trimmomatic 0.32, Trinity
   20140717, Trans-ABySS 1.5.1, BLAST 2.2.29+, HMMER 3.1b2, MAFFT
   7.221beta, Lastz 1.02.00, kentUtils 302, Mr. Bayes 3.2.6, RAxML 8.2.6,
   ASTRAL 4.7.8, FigTree v1.4.2, PAML 4.8, and STRING 11.0.

Supplementary Material

   Supplementary File
   [200]pnas.1814995116.sapp.pdf^ (3.2MB, pdf)
   Supplementary File
   [201]pnas.1814995116.sd01.xlsx^ (317.1KB, xlsx)
   Supplementary File
   [202]pnas.1814995116.sd02.xlsx^ (17.4KB, xlsx)

Acknowledgments
